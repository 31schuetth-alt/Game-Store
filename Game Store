<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Retro Game Store</title>
 <style>
 :root {
 --bg-dark: #121212;
 --bg-panel: #1e1e1e;
 --accent: #6c5ce7;
 --accent-hover: #5649c0;
 --text-main: #ffffff;
 --text-muted: #b3b3b3;
 --success: #00b894;
 --warning: #fdcb6e;
 --danger: #d63031;
 }

 body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 margin: 0;
 background-color: var(--bg-dark);
 color: var(--text-main);
 display: flex;
 height: 100vh;
 overflow: hidden;
 }

 /* Sidebar Styles */
 #sidebar {
 width: 260px;
 background-color: var(--bg-panel);
 display: flex;
 flex-direction: column;
 padding: 20px;
 border-right: 1px solid #333;
 box-shadow: 2px 0 10px rgba(0,0,0,0.3);
 z-index: 10;
 transition: transform 0.3s;
 }

 .profile-section {
 display: flex;
 flex-direction: column;
 align-items: center;
 margin-bottom: 20px;
 text-align: center;
 }

 .profile-pic-container {
 position: relative;
 cursor: pointer;
 group: hover;
 }

 #profile-pic {
 width: 100px;
 height: 100px;
 border-radius: 50%;
 object-fit: cover;
 border: 3px solid var(--accent);
 margin-bottom: 10px;
 transition: transform 0.2s;
 background-color: #000;
 }

 #profile-pic:hover {
 transform: scale(1.05);
 border-color: #fff;
 }

 #username {
 font-size: 1.2rem;
 font-weight: bold;
 margin: 0;
 cursor: pointer;
 }
 
 #username:hover {
 text-decoration: underline;
 }

 .gem-display {
 background: rgba(0,0,0,0.3);
 padding: 8px 15px;
 border-radius: 20px;
 color: var(--warning);
 font-weight: bold;
 display: flex;
 align-items: center;
 gap: 8px;
 margin-top: 10px;
 border: 1px solid #444;
 position: relative; 
 }

 .edit-hint {
 font-size: 0.8rem;
 color: var(--text-muted);
 margin-top: 5px;
 }

 .nav-btn {
 background: transparent;
 border: none;
 color: var(--text-muted);
 padding: 15px;
 text-align: left;
 font-size: 1.1rem;
 cursor: pointer;
 border-radius: 8px;
 transition: 0.2s;
 display: flex;
 align-items: center;
 gap: 10px;
 }

 .nav-btn:hover {
 background: rgba(255,255,255,0.05);
 color: white;
 }

 .nav-btn.active {
 background: var(--accent);
 color: white;
 font-weight: bold;
 }
 
 .logout-container {
 margin-top: auto;
 border-top: 1px solid #333;
 padding-top: 10px;
 }

 /* Main Content Styles */
 #main-content {
 flex: 1;
 padding: 40px;
 overflow-y: auto;
 position: relative;
 }

 h1 {
 border-bottom: 2px solid #333;
 padding-bottom: 15px;
 margin-top: 0;
 }

 .grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
 gap: 20px;
 margin-top: 20px;
 }

 .game-card {
 background: var(--bg-panel);
 border-radius: 12px;
 padding: 20px;
 transition: transform 0.2s, box-shadow 0.2s;
 display: flex;
 flex-direction: column;
 align-items: center;
 text-align: center;
 border: 1px solid #333;
 position: relative;
 }

 .game-card:hover {
 transform: translateY(-5px);
 box-shadow: 0 5px 15px rgba(0,0,0,0.5);
 border-color: var(--accent);
 }

 .price-tag {
 position: absolute;
 top: 10px;
 right: 10px;
 background: #111;
 padding: 4px 8px;
 border-radius: 4px;
 font-size: 0.8rem;
 color: var(--warning);
 border: 1px solid #333;
 }

 .game-icon {
 width: 60px;
 height: 60px;
 background: #333;
 border-radius: 12px;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 30px;
 margin-bottom: 15px;
 }

 .game-title {
 font-weight: bold;
 font-size: 1.1rem;
 margin-bottom: 5px;
 }

 .game-desc {
 color: var(--text-muted);
 font-size: 0.9rem;
 margin-bottom: 20px;
 flex-grow: 1;
 }

 .action-btn {
 width: 100%;
 padding: 10px;
 border: none;
 border-radius: 6px;
 font-weight: bold;
 cursor: pointer;
 transition: 0.2s;
 }

 /* Button Variants */
 .btn-download { background-color: #333; color: white; }
 .btn-download:hover { background-color: #555; }
 .btn-play { background-color: var(--success); color: white; }
 .btn-play:hover { background-color: #00a383; }
 .btn-buy-green { background-color: var(--success); color: white; }
 .btn-buy-green:hover { background-color: #00a383; }
 .btn-buy-red { background-color: var(--danger); color: white; cursor: not-allowed; opacity: 0.8; }
 .btn-buy-red:hover { opacity: 1; }


 .hidden { display: none !important; }

 /* Store Submission Box */
 .submission-box {
 margin-top: 50px;
 padding: 30px;
 background: rgba(253, 203, 110, 0.15); /* Light yellow background */
 border: 2px dashed #fdcb6e; /* Dashed warning border */
 border-radius: 12px;
 color: #ffeaa7; /* Bright readable text */
 font-size: 1.4rem;
 font-weight: bold;
 text-align: center;
 line-height: 1.6;
 box-shadow: 0 5px 20px rgba(0,0,0,0.4);
 }

 /* Task View Styles */
 .task-section {
 background: var(--bg-panel);
 border-radius: 12px;
 padding: 20px;
 margin-bottom: 30px;
 border: 1px solid #333;
 }

 .task-list { display: flex; flex-direction: column; gap: 15px; }
 .task-item {
 background: #111;
 padding: 15px;
 border-radius: 8px;
 display: flex;
 align-items: center;
 justify-content: space-between;
 border: 1px solid #333;
 }
 .task-info { flex: 1; }
 .task-desc { font-weight: bold; margin-bottom: 5px; font-size: 1rem; }
 .task-progress-text { color: var(--text-muted); font-size: 0.85rem; }
 .task-progress-bar {
 height: 6px; background: #333; border-radius: 3px; width: 100px; overflow: hidden; margin-top: 5px;
 }
 .task-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
 .task-reward {
 background: rgba(253, 203, 110, 0.1); color: var(--warning); padding: 5px 10px; border-radius: 6px;
 font-weight: bold; font-size: 0.9rem; margin: 0 15px; border: 1px solid rgba(253, 203, 110, 0.3);
 }
 .btn-claim {
 background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 6px;
 cursor: pointer; font-weight: bold; animation: pulse 2s infinite;
 }
 .btn-claim:disabled { background: #333; color: #666; cursor: default; animation: none; }
 
 @keyframes pulse {
 0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.4); }
 70% { box-shadow: 0 0 0 10px rgba(0, 184, 148, 0); }
 100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); }
 }

 /* Flying Gems Animation */
 .flying-gem {
 position: fixed; font-size: 2.5rem; pointer-events: none; z-index: 10000;
 transition: top 0.8s ease-in, left 0.8s ease-out, opacity 0.3s, transform 0.5s; 
 filter: drop-shadow(0 0 5px rgba(253, 203, 110, 0.5));
 }

 /* Login Screen Styles */
 #login-overlay {
 position: fixed; top: 0; left: 0; width: 100%; height: 100%;
 background: var(--bg-dark); z-index: 3000;
 display: flex; flex-direction: column; align-items: center; justify-content: center;
 }
 
 .login-container {
 width: 600px; max-width: 90%; text-align: center;
 }
 
 .account-grid {
 display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
 gap: 20px; margin-top: 40px; justify-content: center;
 }
 
 .account-card {
 background: var(--bg-panel); border: 1px solid #333; border-radius: 12px;
 padding: 20px; cursor: pointer; transition: 0.2s;
 display: flex; flex-direction: column; align-items: center;
 }
 
 .account-card:hover {
 transform: translateY(-5px); border-color: var(--accent); background: #252525;
 }
 
 .account-avatar {
 width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
 margin-bottom: 10px; border: 2px solid #555;
 }
 
 .account-name { font-weight: bold; color: white; }
 
 .add-account-btn {
 background: transparent; border: 2px dashed #444;
 display: flex; align-items: center; justify-content: center;
 font-size: 2rem; color: #444;
 }
 
 .add-account-btn:hover { border-color: var(--accent); color: var(--accent); }

 /* Modal Styles */
 .modal-overlay {
 position: fixed; top: 0; left: 0; width: 100%; height: 100%;
 background: rgba(0,0,0,0.85); z-index: 4000;
 display: flex; justify-content: center; align-items: center;
 }
 .modal-box {
 background: var(--bg-panel); padding: 30px; border-radius: 12px;
 width: 400px; max-width: 90%; border: 1px solid #333;
 box-shadow: 0 10px 30px rgba(0,0,0,0.5);
 }
 .modal-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
 .form-group { margin-bottom: 20px; }
 .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted); }
 .form-group input[type="text"] {
 width: 100%; padding: 10px; background: #111; border: 1px solid #333;
 color: white; border-radius: 6px; box-sizing: border-box;
 }
 .file-upload-preview { display: flex; align-items: center; gap: 15px; }
 .preview-img {
 width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
 background: #000; border: 2px solid #333;
 }
 input[type="file"] { color: var(--text-muted); }
 .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
 .btn-cancel { background: transparent; border: 1px solid #333; color: var(--text-muted); padding: 8px 16px; border-radius: 6px; cursor: pointer; }
 .btn-save { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

 /* Download Bar & Windows */
 #download-bar {
 position: fixed; bottom: 20px; right: 20px; width: 350px;
 background: #252526; padding: 15px; border-radius: 8px;
 box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #444;
 z-index: 200; display: flex; flex-direction: column; gap: 10px;
 }
 .dl-header { display: flex; justify-content: space-between; align-items: center; }
 .dl-title { font-weight: bold; font-size: 0.95rem; }
 .dl-icon { font-size: 1.2rem; }
 .progress-container {
 height: 20px; background: #111; border-radius: 10px; overflow: hidden;
 border: 1px solid #333; position: relative;
 }
 .progress-bar {
 height: 100%; background: linear-gradient(90deg, #0984e3, #6c5ce7);
 width: 0%; transition: width 0.2s linear;
 }
 .progress-gloss {
 position: absolute; top: 0; left: 0; right: 0; bottom: 0;
 background: linear-gradient(rgba(255,255,255,0.1), transparent);
 }
 .dl-stats { display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa; font-family: monospace; }
 #game-window-container {
 position: fixed; top: 0; left: 0; width: 100%; height: 100%;
 background: rgba(0,0,0,0.6); z-index: 1000; display: flex;
 align-items: center; justify-content: center; backdrop-filter: blur(5px);
 }
 #game-window {
 width: 80%; height: 80%; background: #000; border-radius: 8px; overflow: hidden;
 display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
 border: 1px solid #444; transition: width 0.3s, height 0.3s;
 }
 .window-titlebar {
 height: 40px; background: #202020; display: flex; align-items: center;
 justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333; user-select: none;
 }
 .window-controls { display: flex; gap: 10px; }
 .win-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1rem; padding: 5px; border-radius: 4px; }
 .win-btn:hover { background: #333; color: white; }
 .win-btn.close:hover { background: #d63031; color: white; }
 #game-content-area { flex: 1; position: relative; background: #111; }
 iframe { width: 100%; height: 100%; border: none; display: block; }
 #launcher-screen {
 position: absolute; top: 0; left: 0; width: 100%; height: 100%;
 background: #1e1e1e; display: flex; flex-direction: column;
 align-items: center; justify-content: center; z-index: 10;
 }
 .spinner {
 width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--accent);
 border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
 }
 @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
 #game-window:fullscreen { width: 100vw; height: 100vh; border-radius: 0; border: none; }
 #game-window:fullscreen .window-titlebar { display: none; }
 .toast {
 position: fixed; top: 20px; right: 20px; background: #2ecc71; color: white;
 padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
 z-index: 5000; transform: translateY(-100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
 font-weight: bold; display: flex; align-items: center; gap: 10px;
 }
 .toast.show { transform: translateY(0); }
 .toast.error { background: #d63031; }

 </style>
</head>
<body>

 <!-- Login/Account Overlay -->
 <div id="login-overlay">
 <div class="login-container">
 <h1 style="border:none; font-size: 3rem; margin-bottom: 10px;">Retro Store</h1>
 <p style="color: #aaa; font-size: 1.2rem;">Select your profile</p>
 
 <div id="account-grid" class="account-grid">
 <!-- Accounts injected here by JS, but kept default here just in case JS fails -->
 <div class="account-card" onclick="createNewProfile()">
 <div class="account-avatar add-account-btn">+</div>
 <div class="account-name">New Profile</div>
 </div>
 </div>
 </div>
 </div>

 <!-- Sidebar -->
 <div id="sidebar">
 <div class="profile-section">
 <div class="profile-pic-container" onclick="openProfileModal()">
 <img id="profile-pic" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Profile">
 </div>
 <h3 id="username" onclick="openProfileModal()">Player One</h3>
 <div class="gem-display" id="gem-display-box">
 <span>üíé</span> <span id="gem-count">0</span>
 </div>
 <span class="edit-hint">(Click pic to Edit)</span>
 </div>

 <nav>
 <button class="nav-btn active" id="btn-store" onclick="switchTab('store')">
 üõí Store
 </button>
 <button class="nav-btn" id="btn-library" onclick="switchTab('library')">
 üéÆ My Library
 </button>
 <button class="nav-btn" id="btn-tasks" onclick="switchTab('tasks')">
 üìã Tasks
 </button>
 <button class="nav-btn" id="btn-chat" onclick="switchTab('chat')">
 üí¨ Global Chat
 </button>
 </nav>

 <div class="logout-container">
 <button class="nav-btn" onclick="logout()">
 ‚¨ÖÔ∏è Sign Out
 </button>
 </div>
 </div>

 <!-- Main Content -->
 <div id="main-content">
 <!-- Store View -->
 <div id="view-store">
 <h1>App Store</h1>
 <p style="color: #aaa">Featured Games. First one is on us!</p>
 <div id="store-grid" class="grid"></div>
 
 <div class="submission-box">
 As you can tell, I don't have many games yet. If you have any game code and such you would like to be added, send it to 31schuetth@gjps.org and I might add it! If your game gets added, you will receive 150 gems as a thank you.
 </div>
 </div>

 <!-- Library View -->
 <div id="view-library" class="hidden">
 <h1>My Library</h1>
 <p style="color: #aaa">Your collection.</p>
 <div id="library-grid" class="grid"></div>
 <div id="empty-library-msg" class="hidden" style="margin-top: 20px; color: #666;">
 Library empty. Visit the store to get games!
 </div>
 </div>

 <!-- Tasks View -->
 <div id="view-tasks" class="hidden">
 <h1>Tasks & Rewards</h1>
 <p style="color: #aaa">Complete challenges to earn gems.</p>
 
 <div class="task-section">
 <h2>Daily Tasks <span style="font-size:0.8rem; color:#666; font-weight:normal">(Resets at Midnight)</span></h2>
 <div id="daily-task-list" class="task-list"></div>
 </div>

 <div class="task-section">
 <h2>Weekly Tasks <span style="font-size:0.8rem; color:#666; font-weight:normal">(Resets Sunday 12am)</span></h2>
 <div id="weekly-task-list" class="task-list"></div>
 </div>
 </div>

 <!-- Chat View -->
 <div id="view-chat" class="hidden">
 <h1>Community Chat</h1>
 <p style="color: #aaa">Connect with other players.</p>
 <div class="chat-container" style="height: 80vh; border: 1px solid #333; border-radius: 12px; overflow: hidden; background: #000;">
 <iframe src="https://c7b45104-fdc0-4cd1-a06e-94ad88251447-00-2m7jj6fffwklx.spock.replit.dev/" style="width: 100%; height: 100%; border: none;"></iframe>
 </div>
 </div>
 </div>

 <!-- Realistic Download Bar -->
 <div id="download-bar" class="hidden">
 <div class="dl-header">
 <span id="dl-title" class="dl-title">Downloading Game...</span>
 <span class="dl-icon">üì•</span>
 </div>
 <div class="progress-container">
 <div id="dl-progress" class="progress-bar"></div>
 <div class="progress-gloss"></div>
 </div>
 <div class="dl-stats">
 <span id="dl-status">Initializing...</span>
 <span id="dl-percent">0%</span>
 </div>
 </div>

 <!-- Game Window Modal -->
 <div id="game-window-container" class="hidden">
 <div id="game-window">
 <div class="window-titlebar">
 <span id="win-title" style="font-weight:bold; font-size:0.9rem;">Game Title</span>
 <div class="window-controls">
 <button class="win-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
 <button class="win-btn close" onclick="closeGameWindow()" title="Close">‚úï</button>
 </div>
 </div>
 <div id="game-content-area">
 <div id="launcher-screen">
 <div class="spinner"></div>
 <h3 style="margin-top:0">Launching Game...</h3>
 <p style="color:#666; font-size:0.8rem">Preparing runtime environment</p>
 </div>
 <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
 </div>
 </div>
 </div>

 <!-- Profile Edit Modal -->
 <div id="profile-modal" class="modal-overlay hidden">
 <div class="modal-box">
 <div class="modal-header">Edit Profile</div>
 <div class="form-group">
 <label>Username</label>
 <input type="text" id="edit-username" placeholder="Enter name...">
 </div>
 <div class="form-group">
 <label>Profile Picture</label>
 <div class="file-upload-preview">
 <img id="edit-preview-img" class="preview-img" src="" alt="Preview">
 <input type="file" id="edit-file-input" accept="image/*" onchange="previewFile()">
 </div>
 </div>
 <div class="modal-actions">
 <button class="btn-cancel" onclick="closeProfileModal()">Cancel</button>
 <button class="btn-save" onclick="saveProfile()">Save Changes</button>
 </div>
 </div>
 </div>

 <!-- NEW: Create Profile Modal -->
 <div id="new-profile-modal" class="modal-overlay hidden">
 <div class="modal-box">
 <div class="modal-header">Create New Profile</div>
 <div class="form-group">
 <label>Profile Name</label>
 <input type="text" id="new-profile-name" placeholder="Enter name..." onkeydown="if(event.key==='Enter') confirmCreateProfile()">
 </div>
 <div class="modal-actions">
 <button class="btn-cancel" onclick="closeNewProfileModal()">Cancel</button>
 <button class="btn-save" onclick="confirmCreateProfile()">Create & Play</button>
 </div>
 </div>
 </div>

 <!-- Notification Toast -->
 <div id="toast" class="toast">
 <span id="toast-icon">üíé</span> <span id="toast-msg">You earned 5 gems!</span>
 </div>

 <script>
 // --- DATA ---
 const availableGames = [
 { id: 'tictactoe', title: '2 Player Tic-Tac-Toe', desc: "Tic Tac Toe for two players! Don't play if you rage a lot.", icon: '‚ùå', price: 30, url: 'https://raw.githubusercontent.com/31schuetth-alt/2-Player-Tic-Tac-Toe/ab34402d34b4f85032387c8d8759f91720b276a1/2%20Player%20tic%20tac%20toe' },
 { id: 'billiards', title: 'Billiards and Beyond', desc: "This is more than just Billiards. It's BEYOND Billiards.", icon: 'üé±', price: 50, url: 'https://raw.githubusercontent.com/31schuetth-alt/Beyond-Billiards/refs/heads/main/Beyond%20Billiards' },
 { id: 'pong', title: 'Pong Ultra', desc: "Pong with abilities!", icon: 'üèì', price: 30, url: 'https://raw.githubusercontent.com/31schuetth-alt/Pong/refs/heads/main/Pong' },
 { id: 'snake', title: 'Custom Snake', desc: "Snake but... you could make it MUCH more than normal snake.", icon: 'üêç', price: 25, url: 'https://raw.githubusercontent.com/31schuetth-alt/Snake/refs/heads/main/Snake' },
 { id: 'darts', title: 'Darts', desc: "this is actually really hard not gonna lie", icon: 'üéØ', price: 35, url: 'https://raw.githubusercontent.com/31schuetth-alt/Darts/refs/heads/main/Darts' }
 ];

 const TASK_POOLS = {
 daily: [
 { id: 'play_10', desc: 'Play any game for 10 min', type: 'playtime', goal: 10, reward: 10 },
 { id: 'play_30', desc: 'Play any game for 30 min', type: 'playtime', goal: 30, reward: 30 },
 { id: 'buy_2', desc: 'Purchase 2 games', type: 'purchase', goal: 2, reward: 25 },
 { id: 'buy_1', desc: 'Purchase a game', type: 'purchase', goal: 1, reward: 5 },
 { id: 'login', desc: 'Log in today', type: 'login', goal: 1, reward: 10 } 
 ],
 weekly: [
 { id: 'daily_3', desc: 'Complete all daily tasks 3 days', type: 'daily_set', goal: 3, reward: 30 },
 { id: 'daily_4', desc: 'Complete all daily tasks 4 days', type: 'daily_set', goal: 4, reward: 40 },
 { id: 'daily_5', desc: 'Complete all daily tasks 5 days', type: 'daily_set', goal: 5, reward: 50 },
 { id: 'daily_7', desc: 'Complete all daily tasks 7 days', type: 'daily_set', goal: 7, reward: 100 },
 { id: 'buy_10', desc: 'Purchase 10 games this week', type: 'purchase_week', goal: 10, reward: 50 },
 { id: 'buy_5', desc: 'Purchase 5 games this week', type: 'purchase_week', goal: 5, reward: 25 },
 { id: 'play_90', desc: 'Playtime of 1.5 hours', type: 'playtime_week', goal: 90, reward: 30 },
 { id: 'play_150', desc: 'Playtime of 2.5 hours', type: 'playtime_week', goal: 150, reward: 50 }
 ]
 };

 // --- GLOBAL STATE ---
 let currentUserId = null;
 let usersIndex = []; 

 // --- CURRENT SESSION DATA ---
 let ownedGameIds = [];
 let isDownloading = false;
 let gems = 0;
 let gemInterval = null; 
 let lastActivityTime = 0; 
 let userProfile = { name: "Player One", pic: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix", isDev: false };
 let taskData = { daily: [], weekly: [], lastDailyReset: 0, lastWeeklyReset: 0, dailyCompletedToday: false };

 // --- CORE FUNCTIONS (Moved UP to ensure they are defined before init) ---

 function handleLegacyMigration() {
 try {
 // Check if we have old data but no users
 const oldData = localStorage.getItem('retroStore_v2_data');
 if (oldData && usersIndex.length === 0) {
 console.log("Migrating legacy data to new account system...");
 const parsed = JSON.parse(oldData);
 const newId = 'user_' + Date.now();
 
 // Save old data under new ID
 localStorage.setItem('retroStore_data_' + newId, oldData);
 
 // Add to index
 usersIndex.push({
 id: newId,
 name: parsed.profile?.name || "Player One",
 pic: parsed.profile?.pic || "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"
 });
 saveUserIndex();
 
 // Clear old key to prevent re-migration loop
 localStorage.removeItem('retroStore_v2_data');
 }
 } catch (e) {
 console.error("Migration failed:", e);
 // Even if migration fails, we must continue so app doesn't freeze
 }
 }

 // --- NEW PROFILE LOGIC (No prompts) ---

 function createNewProfile() {
 // Instead of prompt(), open the custom modal
 document.getElementById('new-profile-name').value = "New Player";
 document.getElementById('new-profile-modal').classList.remove('hidden');
 document.getElementById('new-profile-name').focus();
 }

 function closeNewProfileModal() {
 document.getElementById('new-profile-modal').classList.add('hidden');
 }

 function confirmCreateProfile() {
 const nameInput = document.getElementById('new-profile-name').value;
 const name = nameInput.trim() || "New Player";
 
 closeNewProfileModal();

 const newId = 'user_' + Date.now();
 
 // Initialize Default Data
 const defaultData = {
 gems: 0,
 owned: [],
 profile: { name: name, pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${newId}`, isDev: false },
 tasks: { daily: [], weekly: [], lastDailyReset: 0, lastWeeklyReset: 0, dailyCompletedToday: false }
 };
 
 // Save Data
 localStorage.setItem('retroStore_data_' + newId, JSON.stringify(defaultData));
 
 // Update Index
 usersIndex.push({ id: newId, name: defaultData.profile.name, pic: defaultData.profile.pic });
 saveUserIndex();
 
 // Login
 login(newId);
 }

 function saveUserIndex() {
 localStorage.setItem('retroStore_users_index', JSON.stringify(usersIndex));
 }

 function login(userId) {
 try {
 currentUserId = userId;
 
 // Load Data
 const saved = localStorage.getItem('retroStore_data_' + userId);
 if (saved) {
 const data = JSON.parse(saved);
 gems = data.gems || 0;
 ownedGameIds = data.owned || [];
 userProfile = data.profile || userProfile;
 taskData = data.tasks || taskData;
 } else {
 // Fallback (shouldn't happen for created accounts)
 gems = 0; ownedGameIds = [];
 }

 // Hide Login, Show App
 document.getElementById('login-overlay').classList.add('hidden');
 
 // Run App Logic
 checkTaskResets();
 trackProgress('login', 1);
 
 renderStore();
 renderLibrary();
 renderTasks();
 updateGemUI();
 updateProfileUI();
 switchTab('store'); // Reset tab
 } catch (e) {
 console.error("Login failed:", e);
 alert("Error logging in. Try resetting data if this persists.");
 }
 }

 function renderLoginScreen() {
 const grid = document.getElementById('account-grid');
 let html = '';
 
 usersIndex.forEach(u => {
 html += `
 <div class="account-card" onclick="login('${u.id}')">
 <img class="account-avatar" src="${u.pic}" alt="${u.name}">
 <div class="account-name">${u.name}</div>
 </div>
 `;
 });
 
 // Explicitly add the New Profile button again
 html += `
 <div class="account-card" onclick="createNewProfile()">
 <div class="account-avatar add-account-btn">+</div>
 <div class="account-name">New Profile</div>
 </div>
 `;
 
 grid.innerHTML = html;
 document.getElementById('login-overlay').classList.remove('hidden');
 }

 function logout() {
 saveData(); // Save current state
 currentUserId = null;
 stopGemTimer();
 // Close game if open
 if(!document.getElementById('game-window-container').classList.contains('hidden')) {
 closeGameWindow();
 }
 renderLoginScreen();
 }

 function saveData() {
 if (!currentUserId) return;

 const data = {
 gems: gems,
 owned: ownedGameIds,
 profile: userProfile,
 tasks: taskData
 };
 localStorage.setItem('retroStore_data_' + currentUserId, JSON.stringify(data));
 
 // Update index in case name/pic changed
 const userIndexItem = usersIndex.find(u => u.id === currentUserId);
 if (userIndexItem) {
 if (userIndexItem.name !== userProfile.name || userIndexItem.pic !== userProfile.pic) {
 userIndexItem.name = userProfile.name;
 userIndexItem.pic = userProfile.pic;
 saveUserIndex();
 }
 }
 }

 function init() {
 // 1. Load User Index
 const savedIndex = localStorage.getItem('retroStore_users_index');
 if (savedIndex) {
 try { usersIndex = JSON.parse(savedIndex); } catch(e) { console.error(e); }
 }

 // 2. Check for legacy data and migrate if needed
 handleLegacyMigration();

 // 3. Render Login Screen
 renderLoginScreen();
 
 // Listeners
 window.addEventListener('mousemove', updateActivity);
 window.addEventListener('keydown', updateActivity);
 window.addEventListener('click', updateActivity);
 window.addEventListener('message', (e) => { if(e.data === 'activity') updateActivity(); });
 }


 // ... (Remaining Helper Functions) ...

 function updateActivity() { lastActivityTime = Date.now(); }

 function switchTab(tabName) {
 document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
 const btn = document.getElementById('btn-' + tabName);
 if(btn) btn.classList.add('active');

 ['store', 'library', 'tasks', 'chat'].forEach(v => {
 document.getElementById('view-' + v).classList.toggle('hidden', v !== tabName);
 });
 
 if(tabName === 'library') renderLibrary();
 if(tabName === 'tasks') renderTasks();
 }

 function updateGemUI() {
 document.getElementById('gem-count').innerText = gems;
 if(!document.getElementById('view-store').classList.contains('hidden')) renderStore();
 if(!document.getElementById('view-tasks').classList.contains('hidden')) renderTasks();
 }

 function updateProfileUI() {
 document.getElementById('username').innerText = userProfile.name;
 document.getElementById('profile-pic').src = userProfile.pic;
 }

 // --- TASK LOGIC ---

 function checkTaskResets() {
 const now = new Date();
 const lastDaily = new Date(taskData.lastDailyReset);
 const lastWeekly = new Date(taskData.lastWeeklyReset);

 if (now.getDate() !== lastDaily.getDate() || now.getMonth() !== lastDaily.getMonth()) {
 taskData.lastDailyReset = now.getTime();
 taskData.dailyCompletedToday = false;
 const pool = [...TASK_POOLS.daily];
 pool.sort(() => 0.5 - Math.random());
 const picked = pool.slice(0, 3);
 taskData.daily = picked.map(t => ({ id: t.id, goal: t.goal, reward: t.reward, desc: t.desc, type: t.type, progress: 0, claimed: false }));
 if(userProfile.isDev) taskData.daily.forEach(t => t.progress = t.goal);
 saveData();
 }

 const isSunday = now.getDay() === 0;
 const daysSinceWeekly = (now.getTime() - lastWeekly.getTime()) / (1000 * 3600 * 24);
 if (isSunday && daysSinceWeekly > 1) {
 taskData.lastWeeklyReset = now.getTime();
 const pool = [...TASK_POOLS.weekly];
 pool.sort(() => 0.5 - Math.random());
 const picked = pool.slice(0, 5);
 taskData.weekly = picked.map(t => ({ id: t.id, goal: t.goal, reward: t.reward, desc: t.desc, type: t.type, progress: 0, claimed: false }));
 if(userProfile.isDev) taskData.weekly.forEach(t => t.progress = t.goal);
 saveData();
 }
 }

 function trackProgress(type, amount) {
 let saveNeeded = false;
 taskData.daily.forEach(task => {
 if (!task.claimed && task.progress < task.goal) {
 if (task.type === type) {
 task.progress += amount;
 if (task.progress >= task.goal) task.progress = task.goal;
 saveNeeded = true;
 }
 }
 });
 taskData.weekly.forEach(task => {
 if (!task.claimed && task.progress < task.goal) {
 let match = false;
 if (type === 'purchase' && task.type === 'purchase_week') match = true;
 if (type === 'playtime' && task.type === 'playtime_week') match = true;
 if (match) {
 task.progress += amount;
 if (task.progress >= task.goal) task.progress = task.goal;
 saveNeeded = true;
 }
 }
 });
 if (saveNeeded) {
 saveData();
 checkDailySetCompletion();
 if(!document.getElementById('view-tasks').classList.contains('hidden')) renderTasks();
 }
 }

 function checkDailySetCompletion() {
 if (taskData.dailyCompletedToday) return;
 const allDone = taskData.daily.every(t => t.progress >= t.goal);
 if (allDone) {
 taskData.dailyCompletedToday = true;
 taskData.weekly.forEach(task => {
 if (task.type === 'daily_set' && !task.claimed) {
 task.progress += 1;
 if(task.progress > task.goal) task.progress = task.goal;
 }
 });
 saveData();
 }
 }

 function claimReward(listType, index, btnElement) {
 const list = taskData[listType];
 const task = list[index];
 if (task.progress >= task.goal && (!task.claimed || userProfile.isDev)) {
 if (!userProfile.isDev) task.claimed = true;
 saveData();
 renderTasks(); 
 const rect = btnElement.getBoundingClientRect();
 spawnGemTrail(rect, task.reward);
 }
 }

 function spawnGemTrail(btnRect, amount) {
 const targetEl = document.getElementById('gem-display-box');
 const targetRect = targetEl.getBoundingClientRect();
 const targetX = targetRect.left + 10;
 const targetY = targetRect.top + 5;
 const startX = btnRect.left + btnRect.width / 2;
 const startY = btnRect.top + btnRect.height / 2;
 const midX = btnRect.right + 20;
 const midY = btnRect.top + btnRect.height / 2;
 const visualGems = Math.min(amount, 50); 
 const valuePerGem = Math.floor(amount / visualGems);
 const remainder = amount % visualGems;

 for (let i = 0; i < visualGems; i++) {
 const gem = document.createElement('div');
 gem.className = 'flying-gem';
 gem.innerText = 'üíé';
 gem.style.left = `${startX}px`;
 gem.style.top = `${startY}px`;
 gem.style.opacity = '0'; 
 document.body.appendChild(gem);
 setTimeout(() => {
 gem.style.opacity = '1';
 gem.style.left = `${midX + (Math.random() * 20)}px`;
 gem.style.top = `${midY + (Math.random() * 20 - 10)}px`;
 setTimeout(() => {
 gem.style.left = `${targetX}px`;
 gem.style.top = `${targetY}px`;
 gem.style.opacity = '0.5'; 
 gem.style.transform = 'scale(0.5)';
 }, 1000);
 setTimeout(() => {
 gem.remove();
 let addAmount = valuePerGem;
 if (i === visualGems - 1) addAmount += remainder; 
 gems += addAmount;
 updateGemUI();
 if (i === visualGems - 1) saveData(); 
 }, 1800);
 }, i * 100); 
 }
 }

 function renderTasks() {
 const renderList = (tasks, elementId, listType) => {
 const container = document.getElementById(elementId);
 container.innerHTML = '';
 if (tasks.length === 0) {
 container.innerHTML = '<div style="padding:10px; color:#666">No tasks available.</div>';
 return;
 }
 tasks.forEach((task, index) => {
 const pct = (task.progress / task.goal) * 100;
 const isDone = task.progress >= task.goal;
 const item = document.createElement('div');
 item.className = 'task-item';
 item.innerHTML = `
 <div class="task-info">
 <div class="task-desc">${task.desc}</div>
 <div class="task-progress-text">${task.progress} / ${task.goal}</div>
 <div class="task-progress-bar">
 <div class="task-progress-fill" style="width: ${pct}%"></div>
 </div>
 </div>
 <div class="task-reward">+${task.reward} üíé</div>
 <button class="btn-claim" 
 ${isDone && (!task.claimed || userProfile.isDev) ? '' : 'disabled'}
 onclick="claimReward('${listType}', ${index}, this)">
 ${task.claimed && !userProfile.isDev ? 'CLAIMED' : (isDone ? 'CLAIM' : 'LOCKED')}
 </button>
 `;
 container.appendChild(item);
 });
 };
 renderList(taskData.daily, 'daily-task-list', 'daily');
 renderList(taskData.weekly, 'weekly-task-list', 'weekly');
 }

 // --- RENDERERS (Store/Library) ---
 function renderStore() {
 const grid = document.getElementById('store-grid');
 grid.innerHTML = '';
 const gamesDisplay = availableGames.filter(g => !ownedGameIds.includes(g.id));

 if (gamesDisplay.length === 0) {
 grid.innerHTML = '<p style="color:#666">You own all available games!</p>';
 return;
 }

 gamesDisplay.forEach(game => {
 const isFree = ownedGameIds.length === 0;
 const cost = isFree ? 0 : (game.price || 50); 
 const canAfford = gems >= cost;
 
 let btnClass = 'btn-download';
 let btnText = 'GET FREE';
 
 if (!isFree) {
 if (canAfford) {
 btnClass = 'btn-buy-green';
 btnText = `BUY (${cost} üíé)`;
 } else {
 btnClass = 'btn-buy-red';
 btnText = `${cost} üíé`;
 }
 }
 
 const card = document.createElement('div');
 card.className = 'game-card';
 card.innerHTML = `
 <div class="price-tag">${isFree ? "FREE" : cost + " üíé"}</div>
 <div class="game-icon">${game.icon}</div>
 <div class="game-title">${game.title}</div>
 <div class="game-desc">${game.desc}</div>
 <button class="action-btn ${btnClass}" 
 onclick="attemptPurchase('${game.id}', ${cost})"
 ${!canAfford && !isFree ? 'disabled' : ''}>
 ${btnText}
 </button>
 `;
 grid.appendChild(card);
 });
 }

 function renderLibrary() {
 const grid = document.getElementById('library-grid');
 const emptyMsg = document.getElementById('empty-library-msg');
 grid.innerHTML = '';
 if (ownedGameIds.length === 0) {
 emptyMsg.classList.remove('hidden');
 return;
 } else {
 emptyMsg.classList.add('hidden');
 }
 ownedGameIds.forEach(id => {
 const game = availableGames.find(g => g.id === id);
 if (game) {
 const card = document.createElement('div');
 card.className = 'game-card';
 card.innerHTML = `
 <div class="game-icon">${game.icon}</div>
 <div class="game-title">${game.title}</div>
 <div class="game-desc">${game.desc}</div>
 <button class="action-btn btn-play" onclick="launchGameWindow('${game.id}')">PLAY</button>
 `;
 grid.appendChild(card);
 }
 });
 }

 // --- PURCHASE & DOWNLOAD LOGIC ---
 function attemptPurchase(id, cost) {
 if (isDownloading) return;
 if (gems >= cost) {
 gems -= cost;
 saveData();
 updateGemUI();
 startRealisticDownload(id);
 } else {
 showToast("Not enough gems!", true);
 }
 }

 function startRealisticDownload(id) {
 isDownloading = true;
 const game = availableGames.find(g => g.id === id);
 
 const bar = document.getElementById('download-bar');
 const title = document.getElementById('dl-title');
 const progress = document.getElementById('dl-progress');
 const status = document.getElementById('dl-status');
 const percent = document.getElementById('dl-percent');

 bar.classList.remove('hidden');
 title.innerText = `Downloading ${game.title}...`;
 progress.style.width = '0%';
 
 let p = 0;
 const interval = setInterval(() => {
 p += Math.random() * 2;
 if (p > 100) p = 100;
 progress.style.width = p + '%';
 percent.innerText = Math.floor(p) + '%';
 if (p < 20) status.innerText = "Allocating disk space...";
 else if (p < 50) status.innerText = `Downloading ${(p*1.5).toFixed(1)} MB...`;
 else if (p < 80) status.innerText = "Verifying game files...";
 else if (p < 95) status.innerText = "Installing...";
 else status.innerText = "Finalizing...";

 if (p >= 100) {
 clearInterval(interval);
 setTimeout(() => {
 ownedGameIds.push(id);
 saveData();
 trackProgress('purchase', 1);
 bar.classList.add('hidden');
 isDownloading = false;
 renderStore();
 renderLibrary();
 showToast("Game Installed!");
 }, 800);
 }
 }, 90); 
 }

 // --- GAME WINDOW LOGIC ---
 async function launchGameWindow(id) {
 const game = availableGames.find(g => g.id === id);
 if (!game) return;
 const container = document.getElementById('game-window-container');
 const launcher = document.getElementById('launcher-screen');
 const iframe = document.getElementById('game-frame');
 const winTitle = document.getElementById('win-title');
 container.classList.remove('hidden');
 launcher.classList.remove('hidden');
 iframe.style.opacity = '0';
 winTitle.innerText = game.title;
 updateActivity();
 startGemTimer();
 try {
 if (game.url === 'about:blank') {
 iframe.srcdoc = `<div style="color:white;display:flex;justify-content:center;align-items:center;height:100%;flex-direction:column;font-family:sans-serif;"><h1>${game.title}</h1><p>Demo Mode - Gameplay not available</p></div>`;
 } else {
 const response = await fetch(game.url);
 if (!response.ok) throw new Error("Network response was not ok");
 let code = await response.text();
 const trackerScript = `
 <script>
 function notifyParent() { window.parent.postMessage('activity', '*'); }
 window.addEventListener('keydown', notifyParent);
 window.addEventListener('click', notifyParent);
 window.addEventListener('mousemove', notifyParent);
 <\/script>
 `;
 iframe.srcdoc = trackerScript + code;
 }
 } catch (err) {
 iframe.srcdoc = `<h1 style="color:white;text-align:center;padding-top:20px">Error loading game.</h1>`;
 }
 setTimeout(() => {
 launcher.classList.add('hidden');
 iframe.style.opacity = '1';
 iframe.focus();
 }, 2000);
 }

 function closeGameWindow() {
 const container = document.getElementById('game-window-container');
 const iframe = document.getElementById('game-frame');
 container.classList.add('hidden');
 iframe.srcdoc = "";
 stopGemTimer();
 if (document.fullscreenElement) document.exitFullscreen();
 }

 function toggleFullscreen() {
 const elem = document.getElementById('game-window');
 if (!document.fullscreenElement) {
 elem.requestFullscreen().catch(err => { alert(`Error: ${err.message}`); });
 } else {
 document.exitFullscreen();
 }
 }

 // --- GEM SYSTEM & AFK ---
 function startGemTimer() {
 if (gemInterval) clearInterval(gemInterval);
 gemInterval = setInterval(() => {
 const now = Date.now();
 if (now - lastActivityTime < 60000) {
 gems += 5;
 trackProgress('playtime', 1);
 saveData();
 updateGemUI();
 showToast("You earned 5 gems for playing!");
 }
 }, 60000); 
 }

 function stopGemTimer() {
 if (gemInterval) {
 clearInterval(gemInterval);
 gemInterval = null;
 }
 }

 function showToast(msg, isError = false) {
 const toast = document.getElementById('toast');
 document.getElementById('toast-msg').innerText = msg;
 document.getElementById('toast-icon').innerText = isError ? "‚ö†Ô∏è" : "üíé";
 if (isError) toast.classList.add('error'); else toast.classList.remove('error');
 toast.classList.add('show');
 setTimeout(() => { toast.classList.remove('show'); }, 3000);
 }

 // --- PROFILE LOGIC ---
 function openProfileModal() {
 document.getElementById('profile-modal').classList.remove('hidden');
 document.getElementById('edit-username').value = userProfile.name;
 document.getElementById('edit-preview-img').src = userProfile.pic;
 document.getElementById('edit-file-input').value = "";
 }
 function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }
 function previewFile() {
 const fileInput = document.getElementById('edit-file-input');
 const preview = document.getElementById('edit-preview-img');
 if (fileInput.files && fileInput.files[0]) {
 const reader = new FileReader();
 reader.onload = function(e) { preview.src = e.target.result; }
 reader.readAsDataURL(fileInput.files[0]);
 }
 }
 
 function saveProfile() {
 const nameInput = document.getElementById('edit-username').value;
 const preview = document.getElementById('edit-preview-img');
 
 // --- DEVELOPER HACK ---
 if (nameInput === "DEV_1HENRY") {
 userProfile.isDev = true;
 userProfile.name = "Henry";
 gems += 10000;
 taskData.daily.forEach(t => t.progress = t.goal);
 taskData.weekly.forEach(t => t.progress = t.goal);
 showToast("Dev Mode Activated: Infinite Gems & Tasks!");
 saveData();
 renderTasks();
 updateProfileUI();
 updateGemUI();
 closeProfileModal();
 return;
 }

 if (nameInput.trim()) {
 userProfile.name = nameInput.trim();
 document.getElementById('username').innerText = userProfile.name;
 }
 if (preview.src !== userProfile.pic) {
 userProfile.pic = preview.src;
 document.getElementById('profile-pic').src = userProfile.pic;
 }
 saveData(); 
 closeProfileModal();
 }

 init();

 </script>
</body>
</html>
